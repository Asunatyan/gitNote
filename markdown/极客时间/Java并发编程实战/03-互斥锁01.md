## 那原子性问题到底该如何解决呢？

原子性问题的源头是线程切换(导致指令只执行了一半)

“同一时刻只有一个线程执行”这个条件非常重要，我们称之为互斥。

如果我们能够保证对共享变量的修改是互斥的，那么，无论是单核 CPU 还是多核 CPU，就都能保证原子性了。





**受保护资源和锁之间合理的关联关系应该是 N:1 的关系**



一把锁被多个方法使用,那么只有一个拿到锁的方法执行代码,另一个没有拿到锁的方法会等待锁的释放,导致两个方法串行

```java
public class Account {
    // 锁：保护账户余额
    private final Object balLock
      = new Object();
    // 账户余额  
    private Integer balance;
    // 锁：保护账户密码
    private final Object pwLock
      = new Object();
    // 账户密码
    private String password;
  
    // 取款
    void withdraw(Integer amt) {
        System.out.println("withdraw 1");
        synchronized(balLock) {
            if (this.balance > amt){
                this.balance -= amt;
            }
            try {
                Thread.sleep(5000);
                System.out.println("withdraw 2");
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
      }
    } 
    // 查看余额
    Integer getBalance() {
        System.out.println("getBalance 1");
      synchronized(balLock) {
          System.out.println("getBalance 2");
        return balance;
      }
    }
  
    // 更改密码
    void updatePassword(String pw){
      synchronized(pwLock) {
        this.password = pw;
      }
    } 
    // 查看密码
    String getPassword() {
      synchronized(pwLock) {
        return password;
      }
    }

    public static void main(String[] args) {
        Account account = new Account();
        account.balance = 100;
        
        new Thread(()->{ account.withdraw(10);}).start();;
        new Thread(()->{ account.getBalance();}).start();;
    }
  }
```







栗子

```java

class Account {
  private int balance;
  // 转账
  synchronized void transfer(
      Account target, int amt){
    if (this.balance > amt) {
      this.balance -= amt;
      target.balance += amt;
    }
  } 
}
```

![image-20210925211416305](/Users/tamakiakoo/Library/Application Support/typora-user-images/image-20210925211416305.png)

![image-20210925211304520](/Users/tamakiakoo/Library/Application Support/typora-user-images/image-20210925211304520.png)





